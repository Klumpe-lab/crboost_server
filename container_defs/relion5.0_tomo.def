Bootstrap: docker
From: nvidia/cuda:12.2.0-devel-ubuntu22.04

%labels
    Author Gemini
    Version 5.0
    Description RELION 5.0 container with CUDA, MPI, and Python (Tomography/ModelAngelo) support.

%post
    # --------------------------------------------------------------------------------
    # 1. Install System Dependencies
    # --------------------------------------------------------------------------------
    export DEBIAN_FRONTEND=noninteractive
    apt-get update && apt-get install -y \
        build-essential \
        cmake \
        git \
        wget \
        curl \
        unzip \
        openmpi-bin \
        libopenmpi-dev \
        libtiff-dev \
        libpng-dev \
        libjpeg-dev \
        libx11-dev \
        libxft-dev \
        libfftw3-dev \
        libfftw3-mpi-dev \
        libblas-dev \
        liblapack-dev

    # --------------------------------------------------------------------------------
    # 2. Install Miniconda (for Python support)
    # --------------------------------------------------------------------------------
    mkdir -p /opt/software
    cd /opt/software
    wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh
    bash miniconda.sh -b -p /opt/software/conda
    rm miniconda.sh
    
    # Add conda to path for this session
    export PATH="/opt/software/conda/bin:$PATH"

    # --------------------------------------------------------------------------------
    # 3. Clone RELION 5.0 and setup Python Environment
    # --------------------------------------------------------------------------------
    cd /opt/software
    git clone https://github.com/3dem/relion.git
    cd relion
    git checkout ver5.0
    
    # Create the specific conda environment defined by RELION
    # This installs PyTorch, ModelAngelo, DynaMight dependencies, etc.
    conda env create -f environment.yml -n relion-5.0
    
    # Clean up conda cache to reduce image size
    conda clean -a -y

    # --------------------------------------------------------------------------------
    # 4. Build RELION
    # --------------------------------------------------------------------------------
    mkdir build
    cd build
    
    # We explicitly point CMake to the Python interpreter in our new Conda env.
    # The default location for a named env 'relion-5.0' in this miniconda install is:
    PYTHON_PATH=/opt/software/conda/envs/relion-5.0/bin/python
    
    cmake .. \
        -DCUDA=ON \
        -DCudaTexture=ON \
        -DPYTHON_EXE_PATH=$PYTHON_PATH \
        -DCMAKE_INSTALL_PREFIX=/opt/software/relion-install \
        -DFORCE_OWN_FLTK=ON
        
    make -j$(nproc)
    make install
    
    # Cleanup build artifacts to save space (optional, comment out if debugging)
    cd ..
    rm -rf build

%environment
    # --------------------------------------------------------------------------------
    # 5. Runtime Environment Variables
    # --------------------------------------------------------------------------------
    export PATH="/opt/software/relion-install/bin:$PATH"
    export LD_LIBRARY_PATH="/opt/software/relion-install/lib:$LD_LIBRARY_PATH"
    
    # Ensure the Conda environment is active when running the container
    # This is critical for the python-based tasks (Blush, ModelAngelo, Tomo)
    export PATH="/opt/software/conda/envs/relion-5.0/bin:$PATH"
    
    # MPI Path
    export PATH="/usr/lib64/openmpi/bin:$PATH"
    export LD_LIBRARY_PATH="/usr/lib64/openmpi/lib:$LD_LIBRARY_PATH"

%runscript
    # Default command prints version
    echo "Running RELION 5.0 container..."
    exec relion "$@"

%help
    RELION 5.0 (ver5.0) Container
    
    Includes:
    - CUDA 12.2 support
    - OpenMPI
    - Python environment (ModelAngelo, DynaMight, Blush)
    - Tomography support
    
    Usage:
        apptainer run --nv relion5.def
        apptainer exec --nv relion5.def relion_launcher
        
    Note: Always use the --nv flag to expose GPUs to the container.
