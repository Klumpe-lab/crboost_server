Bootstrap: docker
From: nvcr.io/nvidia/cuda:11.8.0-devel-ubuntu20.04

%environment
    export IMOD_DIR=/opt/IMOD
    export PATH="${IMOD_DIR}/bin:$PATH"
    export IMOD_PLUGIN_DIR="${IMOD_DIR}/lib/imod-plugins"
    export IMOD_QTLIBDIR="/usr/lib/x86_64-linux-gnu"
    export CONDA_ENV_PATH="/opt/conda/envs/imod_env"
    export PATH="${CONDA_ENV_PATH}/bin:/opt/conda/bin:$PATH"
    export LD_LIBRARY_PATH="${IMOD_DIR}/lib:${CONDA_ENV_PATH}/lib:/usr/local/cuda/lib64:/usr/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH"
    export CUDA_PATH="/usr/local/cuda"
    export CUDA_HOME="/usr/local/cuda"
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8

%post
    echo "=== STARTING POST-INSTALL SECTION ==="
    export DEBIAN_FRONTEND=noninteractive
    
    # Install ALL dependencies IMOD could possibly need
    apt-get update && apt-get install -y --no-install-recommends \
        wget curl ca-certificates build-essential software-properties-common \
        csh tcsh libncurses5 libglu1-mesa libqt5gui5 libqt5network5 \
        libqt5widgets5 libqt5opengl5 libxft2 libxrender1 libxext6 \
        libgtk2.0-0 openjdk-11-jre git vim sharutils \
        libtiff5 libtiff-dev libpng-dev libjpeg-dev \
        mesa-utils x11-apps expect \
        libxmu6 libxi6 libxt6 libxpm4 libgl1-mesa-glx \
        libsm6 libice6 libx11-6 libxcb1 libxcb-xinerama0 \
        libxcb-util1 libxcb-image0 libxcb-keysyms1 libxcb-randr0 \
        libxcb-shape0 libxcb-sync1 libxcb-xfixes0 libxcb-xkb1 \
        libxcomposite1 libxcursor1 libxdamage1 libxfixes3 \
        libxinerama1 libxkbcommon-x11-0 libxrandr2 libxxf86vm1 \
        libfontconfig1 libfreetype6 libglib2.0-0 \
        && rm -rf /var/lib/apt/lists/*
    
    #----- Install IMOD using a different approach -----#
    echo "=== INSTALLING IMOD 5.1.3 ==="
    mkdir -p /tmp/imod_install && cd /tmp/imod_install
    
    # Download IMOD
    wget --no-check-certificate https://bio3d.colorado.edu/imod/AMD64-RHEL5/imod_5.1.3_RHEL7-64_CUDA10.1.sh
    chmod +x imod_5.1.3_RHEL7-64_CUDA10.1.sh
    
    # Extract the tarball from the self-extracting installer
    # The installer is actually a shell script with a tar archive appended
    # Skip to the end of the script to find the tar data
    echo "Extracting IMOD archive..."
    
    # Method 1: Try to extract using tail
    tail -n +$(awk '/^__ARCHIVE_BELOW__/ {print NR + 1; exit 0; }' imod_5.1.3_RHEL7-64_CUDA10.1.sh) \
         imod_5.1.3_RHEL7-64_CUDA10.1.sh | tar -xz
    
    # If that doesn't work, try Method 2
    if [ ! -d "IMOD" ]; then
        echo "Method 1 failed, trying alternative extraction..."
        # Find the line number where the tar starts
        LINE=$(grep -n '^__ARCHIVE_BELOW__' imod_5.1.3_RHEL7-64_CUDA10.1.sh | cut -d: -f1)
        if [ -n "$LINE" ]; then
            tail -n +$((LINE + 1)) imod_5.1.3_RHEL7-64_CUDA10.1.sh > imod.tar.gz
            tar -xzf imod.tar.gz
        fi
    fi
    
    # Method 3: Try to run installer non-interactively
    if [ ! -d "IMOD" ]; then
        echo "Trying non-interactive installation..."
        # Create response file
        cat > imod_responses.txt << EOF
1
/opt
y
n
EOF
        ./imod_5.1.3_RHEL7-64_CUDA10.1.sh < imod_responses.txt || true
    fi
    
    # Copy to /opt if extraction worked
    if [ -d "IMOD" ]; then
        echo "Found IMOD directory, copying to /opt..."
        cp -r IMOD /opt/
        chmod -R a+rX /opt/IMOD
    else
        echo "WARNING: Could not extract IMOD. Will try direct download..."
        # Try downloading a pre-extracted version if available
        wget --no-check-certificate https://bio3d.colorado.edu/imod/AMD64-RHEL5/IMOD_5.1.3_RHEL7-64_CUDA10.1.tar.gz || true
        if [ -f "IMOD_5.1.3_RHEL7-64_CUDA10.1.tar.gz" ]; then
            tar -xzf IMOD_5.1.3_RHEL7-64_CUDA10.1.tar.gz -C /opt
        fi
    fi
    
    #----- Install Miniconda -----#
    echo "=== INSTALLING MINICONDA ==="
    wget --no-check-certificate https://repo.anaconda.com/miniconda/Miniconda3-py310_24.11.2-0-Linux-x86_64.sh -O /tmp/miniconda.sh
    bash /tmp/miniconda.sh -b -p /opt/conda
    rm /tmp/miniconda.sh
    
    export PATH="/opt/conda/bin:$PATH"
    
    # Initialize conda
    /opt/conda/bin/conda init bash 2>/dev/null
    /opt/conda/bin/conda config --set auto_activate_base false
    
    # Install mamba
    /opt/conda/bin/conda install -n base mamba -c conda-forge -y
    
    # Create environment with specific versions for stability
    /opt/conda/bin/mamba create -n imod_env -y \
        -c conda-forge -c nvidia \
        python=3.10 \
        numpy=1.26 \
        scipy=1.11 \
        matplotlib=3.8 \
        pandas=2.1 \
        scikit-image=0.22 \
        mrcfile=1.4 \
        tifffile=2023.9.26 \
        tqdm=4.66 \
        pyyaml=6.0 \
        cupy-cuda11x=12.2 \
        ipython \
        jupyter \
        pip
    
    # Cleanup
    /opt/conda/bin/conda clean -afy
    apt-get clean
    rm -rf /tmp/imod_install /tmp/miniconda.sh
    echo "=== POST-INSTALL SECTION COMPLETED SUCCESSFULLY ==="

%runscript
    #!/bin/bash
    # Set paths
    export IMOD_DIR=/opt/IMOD
    export CONDA_ENV_PATH="/opt/conda/envs/imod_env"
    export PATH="${IMOD_DIR}/bin:${CONDA_ENV_PATH}/bin:/opt/conda/bin:$PATH"
    export LD_LIBRARY_PATH="${IMOD_DIR}/lib:${CONDA_ENV_PATH}/lib:/usr/local/cuda/lib64:/usr/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH"
    
    # Source IMOD setup if it exists
    if [ -f "${IMOD_DIR}/imod.sh" ]; then
        . "${IMOD_DIR}/imod.sh"
    fi
    
    # If no command given, start bash
    if [ $# -eq 0 ]; then
        exec /bin/bash
    else
        exec "$@"
    fi

%test
    echo "=== TESTING BASIC INSTALL ==="
    
    # Check if IMOD exists
    echo "Looking for IMOD..."
    find /opt -name "imodinfo" -type f 2>/dev/null || echo "IMOD not found"
    
    echo "=== TESTING PYTHON ==="
    /opt/conda/envs/imod_env/bin/python --version
    /opt/conda/envs/imod_env/bin/python -c "
import sys
print(f'Python {sys.version}')
try:
    import mrcfile
    import numpy as np
    import cupy as cp
    print('All Python imports successful!')
except ImportError as e:
    print(f'Import error: {e}')
"
    
    echo "=== TESTING CUDA ==="
    if command -v nvidia-smi &> /dev/null; then
        nvidia-smi --list-gpus
    else
        echo "nvidia-smi not available"
    fi

%labels
    Author YourName
    Version 5.1.3_py3.10
    Description "IMOD with Python for Cryo-ET"
