Bootstrap: docker
From: nvcr.io/nvidia/cuda:11.8.0-devel-ubuntu20.04

%environment
    export PATH="/opt/miniconda3/envs/pytom/bin:$PATH"
    export CUDA_HOME="/usr/local/cuda"
    export LD_LIBRARY_PATH="/opt/miniconda3/envs/pytom/lib:/usr/local/cuda/lib64:$LD_LIBRARY_PATH"

%post
    export DEBIAN_FRONTEND=noninteractive
    apt-get update && apt-get install -y wget git build-essential && rm -rf /var/lib/apt/lists/*

    # 1. Install Miniconda
    cd /opt
    wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh
    bash miniconda.sh -b -p /opt/miniconda3
    rm miniconda.sh
    export PATH="/opt/miniconda3/bin:$PATH"
    
    # 2. Accept Conda ToS
    conda init bash
    conda config --set always_yes true
    conda config --add channels conda-forge
    conda config --set channel_priority strict
    conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/main
    conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/r

    # === NEW: Official PyTOM Installation from Source ===
    # 3. Clone the PyTOM repository
    echo "Cloning PyTOM from GitHub..."
    cd /opt
    git clone https://github.com/SBC-Utrecht/PyTom.git
    cd PyTom

    # 4. Create the Conda environment from their official YAML file
    echo "Creating Conda environment from pytom_full.yaml..."
    conda env create -f environments/pytom_full.yaml --name pytom

    # 5. Compile and install PyTOM into the new environment
    echo "Compiling and installing PyTOM from source..."
    # We use 'conda run' to ensure we're using the python from the 'pytom' env.
    # The --prefix tells setup.py to install directly into that environment.
    conda run -n pytom python setup.py install --prefix /opt/miniconda3/envs/pytom
    # === END NEW SECTION ===

    # 6. Verify installation
    echo "Verifying PyTOM installation..."
    conda run -n pytom python -c "import pytom; print('PyTOM installation successful!')"

    # 7. Clean up
    conda clean --all -y
    cd /
    rm -rf /opt/PyTom

%runscript
    #!/bin/bash
    export PATH="/opt/miniconda3/bin:$PATH"
    . /opt/miniconda3/etc/profile.d/conda.sh
    conda activate pytom
    
    # If no arguments are provided, start an interactive shell
    if [ $# -eq 0 ]; then
        /bin/bash
    else
        exec "$@"
    fi
